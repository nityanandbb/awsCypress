name: Run Cypress Tests

on:
  push:
    branches:
      - main
  workflow_dispatch: # Trigger manually if needed

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Clear npm cache
      - name: Clear npm cache
        run: npm cache clean --force

      # Install cypress-mochawesome-reporter if not already installed
      - name: Install cypress-mochawesome-reporter
        run: |
          if ! npm ls cypress-mochawesome-reporter; then
            npm install --save-dev cypress-mochawesome-reporter
          fi

      # Setup Node.js and install dependencies if version has changed
      - name: Setup Node.js and install dependencies
        if: needs.setup.outputs.versionChanged == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # Install dependencies if version has changed
      - name: Install dependencies
        if: needs.setup.outputs.versionChanged == 'true'
        run: npm install
      # Install Allure com mand line
      - name: install Allure commandline
        run: npm install --save-dev allure-commandline
      # Install Allure Reporter
      - name: Install Allure Reporter
        run: npm install --save-dev allure-cypress

      # Run Cypress tests
      - name: Run Cypress tests
        run: npm run cypress:run --if-present

      # Wait for HTML report to appear (sleep for 25 seconds)
      - name: Wait for HTML report
        run: |
          timeout=30  # Timeout in seconds
          while [ ! -f ./mochawesome-report/index.html ]; do
            sleep 1
            ((timeout--))
            if [ $timeout -eq 0 ]; then
              echo "Timeout reached, HTML report not found."
              exit 1
            fi
          done
      # Generate Allure Report.
      - name: Generate Allure Report.
        run: npx allure serve allure-results
      # Upload Mochawesome report
      - name: Upload Mochawesome report
        if: always()
        uses: actions/upload-artifact@v2
        with:
          name: mochawesome-report
          path: mochawesome-report
